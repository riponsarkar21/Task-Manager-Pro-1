<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Task Manager Pro - Cloud Sync</title>
    <style>
        /* All previous CSS remains... adding new styles for auth and user management */
        
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --radius: 8px;
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }

        * { 
            box-sizing: border-box; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            background-color: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 0; 
            min-height: 100vh;
            display: flex; 
            flex-direction: column;
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
        }

        /* --- Header --- */
        header {
            background: var(--card-bg); 
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: var(--shadow); 
            z-index: 10;
            position: sticky;
            top: 0;
        }
        
        .brand { 
            font-size: 1.1rem; 
            font-weight: 700; 
            color: var(--primary); 
            display: flex; 
            align-items: center; 
            gap: 8px;
        }
        
        .nav-btn {
            background: transparent; 
            border: none; 
            padding: 0.5rem 0.75rem; 
            cursor: pointer; 
            font-weight: 600;
            color: var(--secondary); 
            border-radius: 6px; 
            transition: 0.2s;
            font-size: 0.95rem;
            min-height: 40px;
            min-width: 44px;
        }
        
        .nav-btn.active { 
            background-color: var(--primary); 
            color: white; 
        }
        
        .nav-btn:hover:not(.active) { 
            background-color: var(--bg); 
            color: var(--primary); 
        }

        /* --- Main Layout --- */
        main { 
            flex: 1; 
            padding: 1rem; 
            max-width: 1200px; 
            width: 100%; 
            margin: 0 auto; 
            overflow-y: auto;
        }
        
        @media (max-width: 768px) {
            main {
                padding: 0.75rem;
            }
        }
        
        .view-section { 
            display: none; 
            animation: fadeIn 0.3s ease-in-out; 
        }
        
        .view-section.active { 
            display: block; 
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* --- Inputs & Controls --- */
        .control-panel { 
            background: var(--card-bg); 
            padding: 1.25rem; 
            border-radius: 12px; 
            box-shadow: var(--shadow); 
            margin-bottom: 1.5rem; 
        }
        
        @media (max-width: 768px) {
            .control-panel {
                padding: 1rem;
            }
        }
        
        .input-group { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 1rem; 
            align-items: center; 
            margin-bottom: 1.5rem; 
        }
        
        @media (max-width: 640px) {
            .input-group {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
        }
        
        label { 
            font-weight: 600; 
            font-size: 0.9rem; 
            color: var(--secondary); 
            display: block;
            margin-bottom: 0.25rem;
        }
        
        select, input[type="text"], input[type="date"] {
            padding: 0.75rem 1rem; 
            border: 1px solid var(--border); 
            border-radius: var(--radius); 
            font-size: 1rem;
            background: white; 
            outline: none;
            width: 100%;
        }
        
        select:focus, input:focus { 
            border-color: var(--primary); 
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }
        
        /* --- Buttons --- */
        .btn { 
            padding: 0.75rem 1.5rem; 
            border: none; 
            border-radius: var(--radius); 
            font-weight: 600; 
            cursor: pointer; 
            transition: 0.2s; 
            font-size: 1rem; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            gap: 6px; 
            min-height: 44px;
            width: 100%;
        }
        
        @media (min-width: 640px) {
            .btn {
                width: auto;
            }
        }
        
        .btn-primary { 
            background: var(--primary); 
            color: white; 
        }
        
        .btn-primary:hover { 
            background: var(--primary-dark); 
        }
        
        .btn-secondary { 
            background: white; 
            border: 1px solid var(--border); 
            color: var(--text); 
        }
        
        .btn-secondary:hover { 
            background: var(--bg); 
        }
        
        .btn-danger { 
            background: var(--danger); 
            color: white; 
        }
        
        .btn-success { 
            background: var(--success); 
            color: white; 
        }
        
        .btn-warning { 
            background: var(--warning); 
            color: white; 
        }
        
        .btn-sm { 
            padding: 0.5rem 1rem; 
            font-size: 0.9rem; 
            min-height: 36px;
        }
        
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            width: 100%;
        }
        
        @media (min-width: 640px) {
            .button-group {
                flex-direction: row;
                justify-content: space-between;
            }
        }

        /* --- Cloud Status --- */
        .cloud-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            padding: 0.5rem;
            background: var(--bg);
            border-radius: var(--radius);
            margin-top: 0.5rem;
        }
        
        .cloud-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .cloud-indicator.online {
            background-color: var(--success);
            animation: pulse 2s infinite;
        }
        
        .cloud-indicator.offline {
            background-color: var(--secondary);
        }
        
        .cloud-indicator.syncing {
            background-color: var(--warning);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* --- Shift Tabs --- */
        .shift-tabs { 
            display: flex; 
            gap: 0.25rem; 
            margin-bottom: 1.5rem; 
            background: var(--bg); 
            padding: 0.25rem; 
            border-radius: 8px; 
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .shift-tab { 
            padding: 0.75rem 1rem; 
            border: none; 
            background: transparent; 
            cursor: pointer; 
            border-radius: 6px; 
            font-weight: 600; 
            color: var(--secondary); 
            transition: 0.2s;
            font-size: 0.95rem;
            flex: 1;
            min-width: 60px;
            min-height: 44px;
            white-space: nowrap;
        }
        
        .shift-tab.active { 
            background: white; 
            color: var(--primary); 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
        }

        /* --- Task List --- */
        .task-container { 
            background: var(--card-bg); 
            border-radius: 12px; 
            box-shadow: var(--shadow); 
            padding: 1.5rem;
            min-height: 300px; 
        }
        
        @media (max-width: 768px) {
            .task-container {
                padding: 1.25rem;
            }
        }
        
        .progress-area { 
            margin-bottom: 1.5rem; 
        }
        
        .progress-label { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 0.5rem; 
            font-weight: 600; 
        }
        
        .progress-track { 
            height: 12px; 
            background: var(--bg); 
            border-radius: 6px; 
            overflow: hidden; 
        }
        
        .progress-fill { 
            height: 100%; 
            background: var(--primary); 
            width: 0%; 
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        
        .task-list { 
            list-style: none; 
            padding: 0; 
            margin: 0; 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 0.75rem; 
        }
        
        @media (min-width: 640px) {
            .task-list {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
        }
        
        .task-item { 
            display: flex; 
            align-items: flex-start; 
            padding: 1rem; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            transition: 0.2s; 
            cursor: pointer;
            min-height: 60px;
        }
        
        .task-item:hover { 
            border-color: var(--primary); 
            background-color: #f8fafc; 
        }
        
        .task-item input[type="checkbox"] { 
            width: 1.5rem; 
            height: 1.5rem; 
            margin-right: 1rem; 
            margin-top: 0.125rem;
            cursor: pointer; 
            accent-color: var(--primary); 
            flex-shrink: 0;
        }
        
        .task-item.checked .task-text { 
            text-decoration: line-through; 
            color: var(--secondary); 
        }
        
        .task-item.unchecked { 
            background-color: #fff1f2; 
            border-color: #fecaca; 
        }
        
        .task-item.unchecked .task-text { 
            color: var(--text); 
            font-weight: 500; 
        }

        /* --- Dashboard --- */
        .dashboard-controls { 
            background: white; 
            padding: 1rem; 
            border-radius: var(--radius); 
            box-shadow: var(--shadow); 
            margin-bottom: 1.5rem; 
            display: flex; 
            flex-direction: column;
            gap: 1rem;
        }
        
        @media (min-width: 768px) {
            .dashboard-controls {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        .control-left-group { 
            display: flex; 
            flex-direction: column;
            gap: 1rem; 
            align-items: stretch; 
            width: 100%;
        }
        
        @media (min-width: 640px) {
            .control-left-group {
                flex-direction: row;
                align-items: center;
            }
        }

        .view-toggles { 
            display: flex; 
            gap: 0.25rem; 
            background: var(--bg); 
            padding: 4px; 
            border-radius: 6px; 
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .view-btn { 
            padding: 0.6rem 0.75rem; 
            border: none; 
            background: transparent; 
            cursor: pointer; 
            border-radius: 4px; 
            font-weight: 600; 
            color: var(--secondary); 
            font-size: 0.9rem; 
            flex: 1;
            min-width: 70px;
            min-height: 40px;
            white-space: nowrap;
        }
        
        .view-btn.active { 
            background: white; 
            color: var(--primary); 
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); 
        }
        
        .custom-range-inputs { 
            display: flex; 
            flex-direction: column;
            gap: 0.75rem; 
            width: 100%;
        }
        
        @media (min-width: 640px) {
            .custom-range-inputs {
                flex-direction: row;
                align-items: center;
            }
        }
        
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 1rem; 
            margin-bottom: 1.5rem; 
        }
        
        @media (min-width: 640px) {
            .dashboard-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
        }
        
        .stat-card { 
            background: white; 
            padding: 1.25rem; 
            border-radius: 12px; 
            box-shadow: var(--shadow); 
            border: 1px solid var(--border); 
        }
        
        .stat-title { 
            font-size: 0.9rem; 
            color: var(--secondary); 
            margin-bottom: 0.5rem; 
        }
        
        .stat-value { 
            font-size: 1.75rem; 
            font-weight: 700; 
            color: var(--text); 
        }
        
        .chart-wrapper { 
            height: 200px; 
            display: flex; 
            align-items: flex-end; 
            justify-content: space-around; 
            padding: 1rem 0; 
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .bar-group { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-width: 40px;
            height: 100%; 
            justify-content: flex-end; 
            flex-shrink: 0;
        }
        
        .bar { 
            width: 30px; 
            background: var(--primary); 
            border-radius: 4px 4px 0 0; 
            transition: height 0.5s ease; 
            min-height: 4px; 
            position: relative; 
        }
        
        .bar:hover::after { 
            content: attr(data-val); 
            position: absolute; 
            top: -25px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: #333; 
            color: white; 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-size: 0.75rem; 
            white-space: nowrap; 
        }
        
        .bar-label { 
            margin-top: 0.5rem; 
            font-size: 0.75rem; 
            font-weight: 600; 
            text-align: center; 
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .log-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.9rem; 
            overflow-x: auto;
            display: block;
        }
        
        .log-table th, .log-table td { 
            text-align: left; 
            padding: 0.75rem; 
            border-bottom: 1px solid var(--border); 
            white-space: nowrap;
        }
        
        .log-table th { 
            background: var(--bg); 
            font-weight: 600; 
            cursor: pointer; 
            user-select: none; 
            transition: background 0.2s;
            position: sticky;
            top: 0;
        }
        
        .log-table th:hover { 
            background: #e2e8f0; 
        }
        
        .sort-icon { 
            margin-left: 5px; 
            font-size: 0.8rem; 
            color: var(--secondary); 
        }

        /* --- Modals --- */
        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 100; 
            opacity: 0; 
            transition: opacity 0.3s;
            padding: 1rem;
            box-sizing: border-box;
        }
        
        .modal-overlay.open { 
            display: flex; 
            opacity: 1; 
        }
        
        .modal-window { 
            background: white; 
            width: 100%;
            max-width: 600px; 
            border-radius: 12px; 
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); 
            display: flex; 
            flex-direction: column; 
            max-height: 90vh; 
            transform: scale(0.95); 
            transition: transform 0.3s;
        }
        
        .modal-overlay.open .modal-window { 
            transform: scale(1); 
        }
        
        .modal-header { 
            padding: 1.25rem; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .modal-body { 
            padding: 1.25rem; 
            overflow-y: auto; 
            max-height: 60vh;
        }
        
        .modal-footer { 
            padding: 1rem 1.25rem; 
            border-top: 1px solid var(--border); 
            display: flex; 
            justify-content: flex-end; 
        }
        
        .user-list-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0.75rem; 
            background: var(--bg); 
            border-radius: 6px; 
            margin-bottom: 0.5rem; 
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        /* --- Toast --- */
        .toast-container { 
            position: fixed; 
            bottom: 1rem; 
            right: 1rem; 
            left: 1rem;
            z-index: 200; 
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        @media (min-width: 640px) {
            .toast-container {
                left: auto;
                width: auto;
            }
        }
        
        .toast { 
            background: #333; 
            color: white; 
            padding: 1rem 1.25rem; 
            border-radius: 8px; 
            margin-top: 0.5rem; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); 
            animation: slideIn 0.3s ease-out; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            width: 100%;
            max-width: 350px;
        }
        
        @keyframes slideIn { 
            from { transform: translateX(100%); opacity: 0; } 
            to { transform: translateX(0); opacity: 1; } 
        }
        
        .hidden { 
            display: none !important; 
        }

        /* Mobile-specific enhancements */
        @media (max-width: 480px) {
            header {
                padding: 0.5rem 0.75rem;
            }
            
            .brand {
                font-size: 1rem;
            }
            
            .nav-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.9rem;
                min-width: 40px;
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
            
            .modal-header h3 {
                font-size: 1.1rem;
            }
            
            .task-item {
                padding: 0.875rem;
            }
        }

        html {
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        .scrollable {
            -webkit-overflow-scrolling: touch;
        }
        
        /* Sync buttons */
        .sync-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        /* Debug panel */
        .debug-panel {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
            max-width: 300px;
            display: none;
        }
        
        .debug-toggle {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            z-index: 1001;
        }
        /* ******************************************************* ***************************************************  */

        /* --- Login Screen --- */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }
        
        .login-container {
            background: var(--card-bg);
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
            margin: 1rem;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .login-header h1 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-size: 1.75rem;
        }
        
        .login-header p {
            color: var(--secondary);
            font-size: 0.95rem;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .form-group label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text);
        }
        
        .form-group input {
            padding: 0.875rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 1rem;
            background: white;
            outline: none;
            width: 100%;
        }
        
        .form-group input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }
        
        .login-error {
            background: #fee2e2;
            border: 1px solid #fca5a5;
            color: #dc2626;
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            font-size: 0.9rem;
            display: none;
        }
        
        .login-error.show {
            display: block;
        }
        
        .login-footer {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.85rem;
            color: var(--secondary);
        }
        
        /* --- Dashboard Cards --- */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.25rem;
            margin-top: 1.5rem;
        }
        
        .dashboard-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            min-height: 180px;
            justify-content: center;
        }
        
        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px -8px rgba(0,0,0,0.15);
            border-color: var(--primary);
        }
        
        .dashboard-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .dashboard-card.disabled:hover {
            transform: none;
            box-shadow: var(--shadow);
            border-color: var(--border);
        }
        
        .card-icon {
            width: 56px;
            height: 56px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            color: white;
        }
        
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.5rem;
        }
        
        .card-desc {
            font-size: 0.85rem;
            color: var(--secondary);
        }
        
        /* --- User Management Modal --- */
        .user-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .user-form-grid .form-group {
            margin-bottom: 0;
        }
        
        .responsibilities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin: 1rem 0;
        }
        
        .responsibility-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: var(--bg);
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .responsibility-item:hover {
            background: #e2e8f0;
        }
        
        .responsibility-item.selected {
            background: var(--primary);
            color: white;
        }
        
        .responsibility-item input[type="checkbox"] {
            margin: 0;
        }
        
        /* --- User List Table --- */
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .user-table th, .user-table td {
            padding: 0.875rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        .user-table th {
            background: var(--bg);
            font-weight: 600;
            color: var(--text);
            position: sticky;
            top: 0;
        }
        
        .user-table tr:hover {
            background: var(--bg);
        }
        
        .user-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-active {
            background: #dcfce7;
            color: #166534;
        }
        
        .status-inactive {
            background: #fee2e2;
            color: #991b1b;
        }
        
        /* --- Header User Info --- */
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-left: auto;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .user-details {
            display: flex;
            flex-direction: column;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .user-role {
            font-size: 0.75rem;
            color: var(--secondary);
        }
        
        /* --- Logout Button --- */
        .logout-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--danger);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
            margin-left: 0.5rem;
        }
        
        .logout-btn:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }
        
        /* --- Change Password Modal --- */
        .change-password-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        /* --- Responsive --- */
        @media (max-width: 768px) {
            .login-container {
                padding: 1.5rem;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .user-info {
                display: none;
            }
            
            .user-table {
                font-size: 0.85rem;
            }
            
            .user-table th, .user-table td {
                padding: 0.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .login-container {
                padding: 1.25rem;
                margin: 0.5rem;
            }
            
            .login-header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div class="login-screen" id="login-screen">
        <div class="login-container">
            <div class="login-header">
                <h1>Task Manager Pro</h1>
                <p>Enterprise Task Management System</p>
            </div>
            
            <div class="login-error" id="login-error">
                Invalid credentials. Please try again.
            </div>
            
            <form class="login-form" id="login-form" onsubmit="return auth.login(event)">
                <div class="form-group">
                    <label for="login-userid">User ID</label>
                    <input type="text" id="login-userid" placeholder="Enter User ID" required>
                </div>
                
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" placeholder="Enter Password" required>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    Sign In
                </button>
            </form>
            
            <div class="login-footer">
                Default Admin: User ID "admin", Password "admin"
            </div>
        </div>
    </div>

    <!-- MAIN APPLICATION (Hidden until login) -->
    <div id="app-container" style="display: none;">
        <header>
            <div class="brand">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                Task Manager Pro
            </div>
            
            <div class="user-info" id="user-info">
                <div class="user-avatar" id="user-avatar">U</div>
                <div class="user-details">
                    <div class="user-name" id="user-name">User Name</div>
                    <div class="user-role" id="user-role">Role</div>
                </div>
                <button class="logout-btn" onclick="auth.logout()">Logout</button>
            </div>
            
            <nav id="main-nav">
                <button class="nav-btn active" onclick="app.navigate('dashboard')">Dashboard</button>
                <button class="nav-btn" onclick="app.navigate('tasks')">Tasks</button>
                <button class="nav-btn" onclick="app.navigate('users')" id="users-nav-btn" style="display: none;">User Management</button>
            </nav>
        </header>

        <main>
            <!-- DASHBOARD SECTION (Home Screen) -->
            <section id="section-dashboard" class="view-section active">
                <div class="control-panel">
                    <h2 style="margin: 0 0 1rem 0;">Welcome, <span id="welcome-name">User</span></h2>
                    <p style="color: var(--secondary); margin: 0;">Select a responsibility to manage</p>
                </div>
                
                <div class="dashboard-cards" id="dashboard-cards">
                    <!-- Cards will be populated based on user responsibilities -->
                </div>
            </section>

            <!-- TASKS SECTION (Existing) -->
            <section id="section-tasks" class="view-section">
                <div class="control-panel">
                    <div class="input-group">
                        <!-- User Selection -->
                        <div>
                            <label>Operator:</label>
                            <select id="user-select" onchange="app.renderTasks()">
                                <!-- Options populated by JS -->
                            </select>
                            <button class="btn btn-secondary btn-sm" style="margin-top: 0.5rem;" onclick="userManager.openModal()">+ Add User</button>
                        </div>

                        <!-- Date Picker -->
                        <div>
                            <label>Date:</label>
                            <input type="date" id="report-date" onchange="app.renderTasks()">
                        </div>
                    </div>

                    <div class="shift-tabs">
                        <button class="shift-tab active" onclick="app.setShift('A')">Shift A</button>
                        <button class="shift-tab" onclick="app.setShift('B')">Shift B</button>
                        <button class="shift-tab" onclick="app.setShift('C')">Shift C</button>
                        <button class="shift-tab" onclick="app.setShift('G')">Shift G</button>
                    </div>
                    
                    <!-- Cloud Status -->
                    <div class="cloud-status">
                        <span class="cloud-indicator" id="cloud-status-indicator"></span>
                        <span id="cloud-status-text">Checking connection...</span>
                        <button class="btn btn-sm btn-success" onclick="syncManager.forceSync()" style="margin-left: auto; padding: 0.25rem 0.75rem;">Sync Now</button>
                    </div>
                </div>

                <div class="task-container">
                    <div class="progress-area">
                        <div class="progress-label">
                            <span>Daily Progress</span>
                            <span id="progress-text">0%</span>
                        </div>
                        <div class="progress-track">
                            <div class="progress-fill" id="progress-bar"></div>
                        </div>
                    </div>

                    <ul class="task-list" id="task-list-ui">
                        <!-- Tasks injected here -->
                    </ul>

                    <div style="margin-top: 2rem; border-top: 1px solid var(--border); padding-top: 1.5rem;">
                        <div class="button-group">
                            <button class="btn btn-secondary" onclick="editor.openModal()">Edit Task List</button>
                            <button class="btn btn-primary" onclick="app.submitTasks()">Submit Daily Report</button>
                        </div>
                        
                        <!-- Sync Controls -->
                        <div class="sync-controls">
                            <button class="btn btn-sm btn-success" onclick="syncManager.saveToCloud()">Save to Cloud</button>
                            <button class="btn btn-sm btn-warning" onclick="syncManager.loadFromCloud()">Load from Cloud</button>
                            <button class="btn btn-sm btn-danger" onclick="syncManager.clearLocalData()">Clear Local Data</button>
                            <button class="btn btn-sm btn-secondary" onclick="syncManager.openModal()">Sync Status</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- USER MANAGEMENT SECTION -->
            <section id="section-users" class="view-section">
                <div class="control-panel">
                    <h2 style="margin: 0 0 1rem 0;">User Management</h2>
                    <div class="input-group">
                        <button class="btn btn-primary" onclick="userManagement.openCreateModal()">
                            + Create New User
                        </button>
                        <button class="btn btn-secondary" onclick="userManagement.changePassword()">
                            Change My Password
                        </button>
                    </div>
                </div>

                <div class="task-container">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Name</th>
                                <th>Designation</th>
                                <th>Department</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body">
                            <!-- Users will be populated here -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>

        <!-- EDITOR MODAL (Existing) -->
        <div class="modal-overlay" id="editor-modal">
            <div class="modal-window">
                <div class="modal-header">
                    <h3>Task List Editor (<span id="editor-shift-label"></span>)</h3>
                    <button class="btn btn-secondary btn-sm" onclick="editor.closeModal()">✕</button>
                </div>
                <div class="modal-body">
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 1rem;">
                        <input type="text" id="new-task-input" placeholder="New task description...">
                        <button class="btn btn-primary" onclick="editor.addTask()">Add Task</button>
                    </div>
                    <div id="editor-list-ui"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="editor.closeModal()">Done</button>
                </div>
            </div>
        </div>

        <!-- USER MANAGER MODAL (Existing) -->
        <div class="modal-overlay" id="user-modal">
            <div class="modal-window">
                <div class="modal-header">
                    <h3>User Management</h3>
                    <button class="btn btn-secondary btn-sm" onclick="userManager.closeModal()">✕</button>
                </div>
                <div class="modal-body">
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 1rem;">
                        <input type="text" id="new-user-input" placeholder="Enter name...">
                        <button class="btn btn-primary" onclick="userManager.addUser()">Add User</button>
                    </div>
                    <div id="user-list-ui"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="userManager.closeModal()">Done</button>
                </div>
            </div>
        </div>

        <!-- CREATE USER MODAL -->
        <div class="modal-overlay" id="create-user-modal">
            <div class="modal-window">
                <div class="modal-header">
                    <h3>Create New User</h3>
                    <button class="btn btn-secondary btn-sm" onclick="userManagement.closeCreateModal()">✕</button>
                </div>
                <div class="modal-body">
                    <div class="user-form-grid">
                        <div class="form-group">
                            <label for="new-user-id">User ID *</label>
                            <input type="text" id="new-user-id" placeholder="e.g., 5638" required>
                        </div>
                        <div class="form-group">
                            <label for="new-user-name">Full Name *</label>
                            <input type="text" id="new-user-name" placeholder="e.g., Ripon Sarkar" required>
                        </div>
                        <div class="form-group">
                            <label for="new-user-designation">Designation *</label>
                            <input type="text" id="new-user-designation" placeholder="e.g., Assistant Engineer" required>
                        </div>
                        <div class="form-group">
                            <label for="new-user-department">Department *</label>
                            <select id="new-user-department" required>
                                <option value="">Select Department</option>
                                <option value="Production">Production</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Quality">Quality</option>
                                <option value="Logistics">Logistics</option>
                                <option value="HR">HR</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="new-user-phone">Phone Number</label>
                            <input type="tel" id="new-user-phone" placeholder="+8801XXXXXXXXX">
                        </div>
                        <div class="form-group">
                            <label for="new-user-email">Email</label>
                            <input type="email" id="new-user-email" placeholder="user@company.com">
                        </div>
                        <div class="form-group">
                            <label for="new-user-role">Role *</label>
                            <select id="new-user-role" required onchange="userManagement.onRoleChange()">
                                <option value="">Select Role</option>
                                <option value="Administrator">Administrator</option>
                                <option value="Shift Officer">Shift Officer</option>
                                <option value="Manager">Manager</option>
                                <option value="GM">GM</option>
                                <option value="Worker">Worker</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="new-user-password">Initial Password *</label>
                            <input type="password" id="new-user-password" placeholder="Set initial password" required>
                        </div>
                    </div>
                    
                    <h4 style="margin: 1.5rem 0 1rem 0;">Responsibilities</h4>
                    <div class="responsibilities-grid" id="responsibilities-grid">
                        <!-- Responsibilities will be populated here -->
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="new-user-active" checked>
                            Active User (Can login)
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="userManagement.closeCreateModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="userManagement.createUser()">Create User</button>
                </div>
            </div>
        </div>

        <!-- CHANGE PASSWORD MODAL -->
        <div class="modal-overlay" id="change-password-modal">
            <div class="modal-window">
                <div class="modal-header">
                    <h3>Change Password</h3>
                    <button class="btn btn-secondary btn-sm" onclick="userManagement.closePasswordModal()">✕</button>
                </div>
                <div class="modal-body">
                    <div class="change-password-form">
                        <div class="form-group">
                            <label for="current-password">Current Password</label>
                            <input type="password" id="current-password" required>
                        </div>
                        <div class="form-group">
                            <label for="new-password">New Password</label>
                            <input type="password" id="new-password" required>
                        </div>
                        <div class="form-group">
                            <label for="confirm-password">Confirm New Password</label>
                            <input type="password" id="confirm-password" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="userManagement.closePasswordModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="userManagement.updatePassword()">Change Password</button>
                </div>
            </div>
        </div>

        <!-- CLOUD SYNC MODAL (Existing) -->
        <div class="modal-overlay" id="sync-modal">
            <div class="modal-window">
                <div class="modal-header">
                    <h3>Cloud Sync Status</h3>
                    <button class="btn btn-secondary btn-sm" onclick="syncManager.closeModal()">✕</button>
                </div>
                <div class="modal-body">
                    <div id="sync-status-ui">
                        <!-- Sync status will be shown here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="syncManager.closeModal()">Close</button>
                </div>
            </div>
        </div>

        <div class="toast-container" id="toast-area"></div>
        
        <!-- Debug button -->
        <button class="debug-toggle" onclick="toggleDebug()">?</button>
        <div class="debug-panel" id="debug-panel"></div>
    </div>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    
    <script>
        // ========================
        // SUPABASE CONFIGURATION
        // ========================
        const SUPABASE_URL = 'https://lviiwltmcuypqxlngqpi.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_TKKOqT2n1X9ycoQsucar1w_d9ZivbaG';
        
        // Create Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ========================
        // LOCAL STORAGE KEYS
        // ========================
        const DB_KEY_TASKS = 'tm_tasks';
        const DB_KEY_LOGS = 'tm_logs';
        const DB_KEY_USERS = 'tm_users';
        const DB_KEY_CLOUD_ID = 'tm_cloud_id';
        const DB_KEY_LAST_SYNC = 'tm_last_sync';
        const DB_KEY_AUTH_USERS = 'tm_auth_users';
        const DB_KEY_CURRENT_USER = 'tm_current_user';

        // ========================
        // CONSTANTS
        // ========================
        const RESPONSIBILITIES = {
            TASK_MANAGEMENT: 'Task Management',
            USER_PROFILE: 'User Profile',
            LEAVE_MANAGEMENT: 'Leave Management',
            OVERTIME_MANAGEMENT: 'Overtime Management',
            KPI: 'KPI',
            USER_MANAGEMENT: 'User Management'
        };

        const ALL_RESPONSIBILITIES = Object.values(RESPONSIBILITIES);

        // ========================
        // APPLICATION STATE
        // ========================
        const state = {
            // Authentication state
            currentUser: null,
            authUsers: [],
            
            // Existing state
            currentShift: 'A',
            tasks: {}, 
            logs: [],
            users: [],
            currentChecks: new Set(),
            
            // Cloud state
            cloudConnected: false,
            cloudSyncing: false,
            cloudId: localStorage.getItem(DB_KEY_CLOUD_ID) || null,
            lastSync: localStorage.getItem(DB_KEY_LAST_SYNC) || null,
            
            // Dashboard State
            dashboardMode: 'daily',
            dashUserFilter: 'ALL',
            sortKey: 'reportDate',
            sortOrder: 'desc'
        };

        // ========================
        // AUTHENTICATION MODULE
        // ========================
        const auth = {
            init: () => {
                // Load auth users from localStorage
                const storedUsers = localStorage.getItem(DB_KEY_AUTH_USERS);
                if (storedUsers) {
                    state.authUsers = JSON.parse(storedUsers);
                } else {
                    // Create default admin user
                    state.authUsers = [{
                        userId: 'admin',
                        name: 'Administrator',
                        designation: 'System Administrator',
                        department: 'IT',
                        phone: '',
                        email: '',
                        role: 'Administrator',
                        responsibilities: ALL_RESPONSIBILITIES,
                        password: 'admin', // Default password
                        isActive: true,
                        createdAt: new Date().toISOString(),
                        lastLogin: null
                    }];
                    localStorage.setItem(DB_KEY_AUTH_USERS, JSON.stringify(state.authUsers));
                }

                // Check if user is already logged in
                const storedUser = localStorage.getItem(DB_KEY_CURRENT_USER);
                if (storedUser) {
                    try {
                        const user = JSON.parse(storedUser);
                        const foundUser = state.authUsers.find(u => u.userId === user.userId);
                        if (foundUser && foundUser.isActive && foundUser.password === user.password) {
                            auth.loginUser(foundUser);
                            return;
                        }
                    } catch (e) {
                        console.error('Error parsing stored user:', e);
                    }
                }

                // Show login screen
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
            },

            login: async (event) => {
                event.preventDefault();
                
                const userId = document.getElementById('login-userid').value.trim();
                const password = document.getElementById('login-password').value;
                const errorEl = document.getElementById('login-error');
                
                // Find user
                const user = state.authUsers.find(u => 
                    u.userId === userId && 
                    u.password === password && 
                    u.isActive === true
                );
                
                if (user) {
                    // Update last login
                    user.lastLogin = new Date().toISOString();
                    localStorage.setItem(DB_KEY_AUTH_USERS, JSON.stringify(state.authUsers));
                    
                    // Save current user
                    localStorage.setItem(DB_KEY_CURRENT_USER, JSON.stringify({
                        userId: user.userId,
                        password: user.password
                    }));
                    
                    auth.loginUser(user);
                    errorEl.classList.remove('show');
                } else {
                    errorEl.classList.add('show');
                }
                
                return false;
            },

            loginUser: (user) => {
                state.currentUser = user;
                
                // Hide login, show app
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                
                // Update UI
                document.getElementById('user-name').textContent = user.name;
                document.getElementById('user-role').textContent = user.role;
                document.getElementById('welcome-name').textContent = user.name;
                document.getElementById('user-avatar').textContent = user.name.charAt(0).toUpperCase();
                
                // Show/hide navigation based on responsibilities
                const usersNavBtn = document.getElementById('users-nav-btn');
                if (user.responsibilities.includes(RESPONSIBILITIES.USER_MANAGEMENT) || user.role === 'Administrator') {
                    usersNavBtn.style.display = 'inline-block';
                } else {
                    usersNavBtn.style.display = 'none';
                }
                
                // Load existing modules
                app.loadFromLocalStorage();
                
                // Render dashboard cards based on responsibilities
                auth.renderDashboardCards();
                
                // Initialize cloud sync
                setTimeout(async () => {
                    const connected = await syncManager.testConnection();
                    if (connected) {
                        await syncManager.loadFromCloud();
                    }
                }, 500);
                
                showToast(`Welcome back, ${user.name}!`, 'success');
            },

            logout: () => {
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.removeItem(DB_KEY_CURRENT_USER);
                    state.currentUser = null;
                    
                    document.getElementById('login-screen').style.display = 'flex';
                    document.getElementById('app-container').style.display = 'none';
                    
                    // Clear form
                    document.getElementById('login-userid').value = '';
                    document.getElementById('login-password').value = '';
                    document.getElementById('login-error').classList.remove('show');
                    
                    showToast('You have been logged out', 'success');
                }
            },

            renderDashboardCards: () => {
                const cardsContainer = document.getElementById('dashboard-cards');
                cardsContainer.innerHTML = '';
                
                const user = state.currentUser;
                if (!user) return;
                
                // Define all possible cards
                const allCards = [
                    {
                        id: 'tasks',
                        title: 'Task Management',
                        description: 'Manage daily tasks and reports',
                        icon: '📋',
                        responsibility: RESPONSIBILITIES.TASK_MANAGEMENT,
                        onclick: () => app.navigate('tasks')
                    },
                    {
                        id: 'profile',
                        title: 'User Profile',
                        description: 'View and edit your profile',
                        icon: '👤',
                        responsibility: RESPONSIBILITIES.USER_PROFILE,
                        onclick: () => showToast('User Profile module coming soon!', 'info')
                    },
                    {
                        id: 'leave',
                        title: 'Leave Management',
                        description: 'Apply and manage leave requests',
                        icon: '🏖️',
                        responsibility: RESPONSIBILITIES.LEAVE_MANAGEMENT,
                        onclick: () => showToast('Leave Management module coming soon!', 'info')
                    },
                    {
                        id: 'overtime',
                        title: 'Overtime Management',
                        description: 'Track and approve overtime',
                        icon: '⏰',
                        responsibility: RESPONSIBILITIES.OVERTIME_MANAGEMENT,
                        onclick: () => showToast('Overtime Management module coming soon!', 'info')
                    },
                    {
                        id: 'kpi',
                        title: 'KPI Dashboard',
                        description: 'View performance metrics',
                        icon: '📊',
                        responsibility: RESPONSIBILITIES.KPI,
                        onclick: () => showToast('KPI Dashboard module coming soon!', 'info')
                    },
                    {
                        id: 'users',
                        title: 'User Management',
                        description: 'Manage system users and permissions',
                        icon: '👥',
                        responsibility: RESPONSIBILITIES.USER_MANAGEMENT,
                        onclick: () => app.navigate('users')
                    }
                ];
                
                // Filter cards based on user responsibilities
                let filteredCards = [];
                if (user.role === 'Administrator') {
                    filteredCards = allCards;
                } else {
                    filteredCards = allCards.filter(card => 
                        user.responsibilities.includes(card.responsibility)
                    );
                }
                
                // Render cards
                filteredCards.forEach(card => {
                    const cardEl = document.createElement('div');
                    cardEl.className = 'dashboard-card';
                    cardEl.onclick = card.onclick;
                    
                    cardEl.innerHTML = `
                        <div class="card-icon">${card.icon}</div>
                        <div class="card-title">${card.title}</div>
                        <div class="card-desc">${card.description}</div>
                    `;
                    
                    cardsContainer.appendChild(cardEl);
                });
                
                // If no cards, show message
                if (filteredCards.length === 0) {
                    cardsContainer.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: var(--secondary);">
                            <h3>No responsibilities assigned</h3>
                            <p>Contact your administrator to get access to system modules.</p>
                        </div>
                    `;
                }
            }
        };

        // ========================
        // USER MANAGEMENT MODULE
        // ========================
        const userManagement = {
            openCreateModal: () => {
                // Check permission
                if (!state.currentUser || 
                   (!state.currentUser.responsibilities.includes(RESPONSIBILITIES.USER_MANAGEMENT) && 
                    state.currentUser.role !== 'Administrator')) {
                    showToast('You do not have permission to create users', 'error');
                    return;
                }
                
                // Reset form
                document.getElementById('new-user-id').value = '';
                document.getElementById('new-user-name').value = '';
                document.getElementById('new-user-designation').value = '';
                document.getElementById('new-user-department').value = '';
                document.getElementById('new-user-phone').value = '';
                document.getElementById('new-user-email').value = '';
                document.getElementById('new-user-role').value = '';
                document.getElementById('new-user-password').value = '';
                document.getElementById('new-user-active').checked = true;
                
                // Render responsibilities grid
                this.renderResponsibilitiesGrid([]);
                
                // Show modal
                document.getElementById('create-user-modal').classList.add('open');
            },

            closeCreateModal: () => {
                document.getElementById('create-user-modal').classList.remove('open');
            },

            onRoleChange: () => {
                const role = document.getElementById('new-user-role').value;
                let defaultResponsibilities = [];
                
                switch(role) {
                    case 'Administrator':
                        defaultResponsibilities = ALL_RESPONSIBILITIES;
                        break;
                    case 'Manager':
                    case 'GM':
                        defaultResponsibilities = [
                            RESPONSIBILITIES.TASK_MANAGEMENT,
                            RESPONSIBILITIES.LEAVE_MANAGEMENT,
                            RESPONSIBILITIES.OVERTIME_MANAGEMENT,
                            RESPONSIBILITIES.KPI
                        ];
                        break;
                    case 'Shift Officer':
                        defaultResponsibilities = [
                            RESPONSIBILITIES.TASK_MANAGEMENT,
                            RESPONSIBILITIES.USER_PROFILE
                        ];
                        break;
                    case 'Worker':
                        defaultResponsibilities = [
                            RESPONSIBILITIES.TASK_MANAGEMENT,
                            RESPONSIBILITIES.USER_PROFILE
                        ];
                        break;
                }
                
                this.renderResponsibilitiesGrid(defaultResponsibilities);
            },

            renderResponsibilitiesGrid: (selectedResponsibilities) => {
                const grid = document.getElementById('responsibilities-grid');
                grid.innerHTML = '';
                
                ALL_RESPONSIBILITIES.forEach(resp => {
                    const isSelected = selectedResponsibilities.includes(resp);
                    const item = document.createElement('div');
                    item.className = `responsibility-item ${isSelected ? 'selected' : ''}`;
                    
                    item.innerHTML = `
                        <input type="checkbox" id="resp-${resp.replace(/\s+/g, '-')}" 
                               ${isSelected ? 'checked' : ''}>
                        <label for="resp-${resp.replace(/\s+/g, '-')}">${resp}</label>
                    `;
                    
                    item.onclick = (e) => {
                        if (e.target.type !== 'checkbox') {
                            const checkbox = item.querySelector('input[type="checkbox"]');
                            checkbox.checked = !checkbox.checked;
                            item.classList.toggle('selected', checkbox.checked);
                        }
                    };
                    
                    grid.appendChild(item);
                });
            },

            getSelectedResponsibilities: () => {
                const selected = [];
                ALL_RESPONSIBILITIES.forEach(resp => {
                    const checkbox = document.getElementById(`resp-${resp.replace(/\s+/g, '-')}`);
                    if (checkbox && checkbox.checked) {
                        selected.push(resp);
                    }
                });
                return selected;
            },

            createUser: () => {
                // Validate required fields
                const userId = document.getElementById('new-user-id').value.trim();
                const name = document.getElementById('new-user-name').value.trim();
                const designation = document.getElementById('new-user-designation').value.trim();
                const department = document.getElementById('new-user-department').value;
                const role = document.getElementById('new-user-role').value;
                const password = document.getElementById('new-user-password').value;
                
                if (!userId || !name || !designation || !department || !role || !password) {
                    showToast('Please fill all required fields (*)', 'error');
                    return;
                }
                
                // Check if user ID already exists
                if (state.authUsers.some(u => u.userId === userId)) {
                    showToast('User ID already exists', 'error');
                    return;
                }
                
                // Get selected responsibilities
                const responsibilities = this.getSelectedResponsibilities();
                
                // Create new user
                const newUser = {
                    userId: userId,
                    name: name,
                    designation: designation,
                    department: department,
                    phone: document.getElementById('new-user-phone').value.trim(),
                    email: document.getElementById('new-user-email').value.trim(),
                    role: role,
                    responsibilities: responsibilities,
                    password: password,
                    isActive: document.getElementById('new-user-active').checked,
                    createdAt: new Date().toISOString(),
                    lastLogin: null
                };
                
                // Add to auth users
                state.authUsers.push(newUser);
                localStorage.setItem(DB_KEY_AUTH_USERS, JSON.stringify(state.authUsers));
                
                // Also add to task users list if not exists
                if (!state.users.includes(name)) {
                    state.users.push(name);
                    localStorage.setItem(DB_KEY_USERS, JSON.stringify(state.users));
                }
                
                // Save to cloud if connected
                if (state.cloudConnected) {
                    syncManager.saveToCloud();
                }
                
                // Close modal and refresh user list
                this.closeCreateModal();
                this.renderUserTable();
                
                showToast(`User ${name} created successfully!`, 'success');
            },

            renderUserTable: () => {
                const tbody = document.getElementById('user-table-body');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                // Sort users: current user first, then by name
                const sortedUsers = [...state.authUsers].sort((a, b) => {
                    if (a.userId === state.currentUser.userId) return -1;
                    if (b.userId === state.currentUser.userId) return 1;
                    return a.name.localeCompare(b.name);
                });
                
                sortedUsers.forEach(user => {
                    const tr = document.createElement('tr');
                    
                    // Action buttons based on permissions
                    let actions = '';
                    if (state.currentUser.role === 'Administrator' || 
                       (state.currentUser.responsibilities.includes(RESPONSIBILITIES.USER_MANAGEMENT) && 
                        user.userId !== state.currentUser.userId)) {
                        actions = `
                            <div class="user-actions">
                                <button class="btn btn-sm ${user.isActive ? 'btn-warning' : 'btn-success'}" 
                                        onclick="userManagement.toggleUserStatus('${user.userId}')">
                                    ${user.isActive ? 'Deactivate' : 'Activate'}
                                </button>
                                <button class="btn btn-sm btn-danger" 
                                        onclick="userManagement.deleteUser('${user.userId}')"
                                        ${user.userId === 'admin' ? 'disabled' : ''}>
                                    Delete
                                </button>
                            </div>
                        `;
                    } else {
                        actions = '<span style="color: var(--secondary);">No actions</span>';
                    }
                    
                    tr.innerHTML = `
                        <td><strong>${user.userId}</strong></td>
                        <td>${user.name}</td>
                        <td>${user.designation}</td>
                        <td>${user.department}</td>
                        <td>${user.role}</td>
                        <td>
                            <span class="status-badge ${user.isActive ? 'status-active' : 'status-inactive'}">
                                ${user.isActive ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>${actions}</td>
                    `;
                    
                    tbody.appendChild(tr);
                });
            },

            toggleUserStatus: (userId) => {
                if (userId === state.currentUser.userId) {
                    showToast('You cannot change your own status', 'error');
                    return;
                }
                
                const user = state.authUsers.find(u => u.userId === userId);
                if (user) {
                    user.isActive = !user.isActive;
                    localStorage.setItem(DB_KEY_AUTH_USERS, JSON.stringify(state.authUsers));
                    this.renderUserTable();
                    
                    showToast(`User ${user.name} ${user.isActive ? 'activated' : 'deactivated'}`, 'success');
                }
            },

            deleteUser: (userId) => {
                if (userId === 'admin') {
                    showToast('Cannot delete system administrator', 'error');
                    return;
                }
                
                if (userId === state.currentUser.userId) {
                    showToast('You cannot delete yourself', 'error');
                    return;
                }
                
                if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                    const index = state.authUsers.findIndex(u => u.userId === userId);
                    if (index !== -1) {
                        const userName = state.authUsers[index].name;
                        state.authUsers.splice(index, 1);
                        localStorage.setItem(DB_KEY_AUTH_USERS, JSON.stringify(state.authUsers));
                        this.renderUserTable();
                        
                        showToast(`User ${userName} deleted successfully`, 'success');
                    }
                }
            },

            changePassword: () => {
                document.getElementById('current-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
                document.getElementById('change-password-modal').classList.add('open');
            },

            closePasswordModal: () => {
                document.getElementById('change-password-modal').classList.remove('open');
            },

            updatePassword: () => {
                const current = document.getElementById('current-password').value;
                const newPass = document.getElementById('new-password').value;
                const confirmPass = document.getElementById('confirm-password').value;
                
                if (!current || !newPass || !confirmPass) {
                    showToast('Please fill all fields', 'error');
                    return;
                }
                
                if (newPass !== confirmPass) {
                    showToast('New passwords do not match', 'error');
                    return;
                }
                
                if (state.currentUser.password !== current) {
                    showToast('Current password is incorrect', 'error');
                    return;
                }
                
                // Update password
                state.currentUser.password = newPass;
                const userIndex = state.authUsers.findIndex(u => u.userId === state.currentUser.userId);
                if (userIndex !== -1) {
                    state.authUsers[userIndex].password = newPass;
                    localStorage.setItem(DB_KEY_AUTH_USERS, JSON.stringify(state.authUsers));
                    
                    // Update stored current user
                    localStorage.setItem(DB_KEY_CURRENT_USER, JSON.stringify({
                        userId: state.currentUser.userId,
                        password: newPass
                    }));
                }
                
                this.closePasswordModal();
                showToast('Password changed successfully!', 'success');
            }
        };

        // ========================
        // UTILITY FUNCTIONS
        // ========================
        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);
        
        const showToast = (msg, type = 'success') => {
            const area = document.getElementById('toast-area');
            if (!area) return;
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.borderLeft = `4px solid ${type === 'success' ? 'var(--success)' : type === 'warning' ? 'var(--warning)' : 'var(--danger)'}`;
            toast.innerText = msg;
            area.appendChild(toast);
            setTimeout(() => { 
                toast.style.opacity = '0'; 
                setTimeout(() => toast.remove(), 300); 
            }, 3000);
        };
        
        const debugLog = (message, data = null) => {
            const debugPanel = document.getElementById('debug-panel');
            if (!debugPanel) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<strong>${timestamp}:</strong> ${message}`;
            if (data) {
                logEntry.innerHTML += `<pre style="margin: 5px 0; font-size: 10px; overflow: auto;">${JSON.stringify(data, null, 2)}</pre>`;
            }
            debugPanel.appendChild(logEntry);
            debugPanel.scrollTop = debugPanel.scrollHeight;
            console.log(`[${timestamp}] ${message}`, data || '');
        };
        
        const toggleDebug = () => {
            const panel = document.getElementById('debug-panel');
            if (panel) {
                panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
            }
        };
        
        const updateCloudStatus = (status) => {
            const indicator = document.getElementById('cloud-status-indicator');
            const text = document.getElementById('cloud-status-text');
            
            if (!indicator || !text) return;
            
            switch(status) {
                case 'online':
                    indicator.className = 'cloud-indicator online';
                    text.textContent = 'Connected to cloud';
                    state.cloudConnected = true;
                    break;
                case 'offline':
                    indicator.className = 'cloud-indicator offline';
                    text.textContent = 'Offline - using local storage';
                    state.cloudConnected = false;
                    break;
                case 'syncing':
                    indicator.className = 'cloud-indicator syncing';
                    text.textContent = 'Syncing with cloud...';
                    state.cloudSyncing = true;
                    break;
                case 'error':
                    indicator.className = 'cloud-indicator offline';
                    text.textContent = 'Cloud sync error';
                    state.cloudConnected = false;
                    break;
            }
            state.cloudSyncing = status === 'syncing';
        };

        // ========================
        // SYNC MANAGER
        // ========================
        const syncManager = {
            // Test connection to Supabase
            testConnection: async () => {
                try {
                    updateCloudStatus('syncing');
                    debugLog('Testing Supabase connection...');
                    
                    if (!window.supabase || !supabase) {
                        throw new Error('Supabase client not loaded');
                    }
                    
                    debugLog('Supabase client loaded, testing connection...');
                    
                    const { data, error } = await supabase
                        .from('task_manager_data')
                        .select('id')
                        .limit(1);
                    
                    if (error) {
                        if (error.message.includes('relation') || error.message.includes('does not exist')) {
                            debugLog('Table does not exist, will create on first save');
                            updateCloudStatus('online');
                            return true;
                        }
                        throw error;
                    }
                    
                    debugLog('Supabase connection successful', data);
                    updateCloudStatus('online');
                    return true;
                } catch (error) {
                    console.error('Supabase connection failed:', error);
                    debugLog('Connection failed:', error.message);
                    updateCloudStatus('offline');
                    
                    let errorMsg = 'Connection failed';
                    if (error.message.includes('Failed to fetch')) {
                        errorMsg = 'Network error - check internet connection';
                    } else if (error.message.includes('JWT')) {
                        errorMsg = 'Authentication error - check Supabase credentials';
                    } else if (error.message.includes('relation')) {
                        errorMsg = 'Table not found - will create on first save';
                    }
                    
                    showToast(errorMsg, 'error');
                    return false;
                }
            },
            
            // Save data to Supabase
            saveToCloud: async () => {
                try {
                    if (!navigator.onLine) {
                        showToast('No internet connection', 'error');
                        return null;
                    }
                    
                    updateCloudStatus('syncing');
                    debugLog('Saving data to cloud...');
                    
                    // Prepare data with auth users
                    const cloudData = {
                        tasks: state.tasks,
                        logs: state.logs,
                        users: state.users,
                        auth_users: state.authUsers,
                        last_updated: new Date().toISOString(),
                        device_id: navigator.userAgent.substring(0, 100)
                    };
                    
                    let result;
                    
                    if (state.cloudId) {
                        debugLog('Updating existing record:', state.cloudId);
                        const { data, error } = await supabase
                            .from('task_manager_data')
                            .update(cloudData)
                            .eq('id', state.cloudId)
                            .select();
                        
                        if (error) {
                            // If record doesn't exist, create new one
                            if (error.code === 'PGRST116' || error.message.includes('No rows found')) {
                                debugLog('Record not found, creating new one');
                                state.cloudId = null;
                                localStorage.removeItem(DB_KEY_CLOUD_ID);
                                
                                // Create new record
                                const { data: newData, error: newError } = await supabase
                                    .from('task_manager_data')
                                    .insert([cloudData])
                                    .select();
                                
                                if (newError) throw newError;
                                result = newData[0];
                                state.cloudId = result.id;
                                localStorage.setItem(DB_KEY_CLOUD_ID, result.id);
                            } else {
                                throw error;
                            }
                        } else {
                            result = data && data.length > 0 ? data[0] : cloudData;
                        }
                    } else {
                        debugLog('Creating new record');
                        const { data, error } = await supabase
                            .from('task_manager_data')
                            .insert([cloudData])
                            .select();
                        
                        if (error) throw error;
                        result = data[0];
                        state.cloudId = result.id;
                        localStorage.setItem(DB_KEY_CLOUD_ID, result.id);
                    }
                    
                    state.lastSync = new Date().toISOString();
                    localStorage.setItem(DB_KEY_LAST_SYNC, state.lastSync);
                    
                    updateCloudStatus('online');
                    showToast('Data saved to cloud successfully!');
                    debugLog('Save successful:', { id: state.cloudId, last_updated: state.lastSync });
                    return result;
                } catch (error) {
                    console.error('Error saving to cloud:', error);
                    debugLog('Save failed:', error);
                    updateCloudStatus('error');
                    showToast('Failed to save to cloud: ' + error.message, 'error');
                    return null;
                }
            },
            
            // Load data from Supabase
            loadFromCloud: async () => {
                try {
                    if (!navigator.onLine) {
                        showToast('No internet connection', 'error');
                        return null;
                    }
                    
                    updateCloudStatus('syncing');
                    debugLog('Loading data from cloud...');
                    
                    let data = null;
                    
                    if (state.cloudId) {
                        debugLog('Loading specific record:', state.cloudId);
                        const { data: recordData, error } = await supabase
                            .from('task_manager_data')
                            .select('*')
                            .eq('id', state.cloudId)
                            .maybeSingle();
                        
                        if (error) {
                            // If record doesn't exist, try to get latest
                            if (error.code === 'PGRST116' || error.message.includes('No rows found')) {
                                debugLog('Specific record not found, loading latest');
                                state.cloudId = null;
                                localStorage.removeItem(DB_KEY_CLOUD_ID);
                                
                                // Try to get latest record
                                const { data: latestData, error: latestError } = await supabase
                                    .from('task_manager_data')
                                    .select('*')
                                    .order('last_updated', { ascending: false })
                                    .limit(1);
                                
                                if (latestError) throw latestError;
                                data = latestData;
                            } else {
                                throw error;
                            }
                        } else {
                            data = recordData ? [recordData] : null;
                        }
                    } else {
                        debugLog('Loading most recent record');
                        const { data: latestData, error } = await supabase
                            .from('task_manager_data')
                            .select('*')
                            .order('last_updated', { ascending: false })
                            .limit(1);
                        
                        if (error) throw error;
                        data = latestData;
                    }
                    
                    if (data && data.length > 0) {
                        const cloudData = data[0];
                        debugLog('Data loaded from cloud:', cloudData);
                        
                        // Update local state
                        state.tasks = cloudData.tasks || {};
                        state.logs = cloudData.logs || [];
                        state.users = cloudData.users || ["Operator 1", "Manager", "Supervisor"];
                        state.authUsers = cloudData.auth_users || state.authUsers;
                        state.cloudId = cloudData.id;
                        state.lastSync = cloudData.last_updated;
                        
                        // Save to localStorage
                        localStorage.setItem(DB_KEY_TASKS, JSON.stringify(state.tasks));
                        localStorage.setItem(DB_KEY_LOGS, JSON.stringify(state.logs));
                        localStorage.setItem(DB_KEY_USERS, JSON.stringify(state.users));
                        localStorage.setItem(DB_KEY_AUTH_USERS, JSON.stringify(state.authUsers));
                        localStorage.setItem(DB_KEY_CLOUD_ID, state.cloudId);
                        localStorage.setItem(DB_KEY_LAST_SYNC, state.lastSync);
                        
                        updateCloudStatus('online');
                        showToast('Data loaded from cloud successfully!');
                        return cloudData;
                    } else {
                        debugLog('No cloud data found');
                        showToast('No cloud data found', 'warning');
                        updateCloudStatus('online');
                        return null;
                    }
                } catch (error) {
                    console.error('Error loading from cloud:', error);
                    debugLog('Load failed:', error);
                    updateCloudStatus('error');
                    showToast('Failed to load from cloud: ' + error.message, 'error');
                    return null;
                }
            },
            
            forceSync: async () => {
                debugLog('Force sync started');
                await syncManager.saveToCloud();
                await syncManager.loadFromCloud();
                
                // Refresh UI if on tasks page
                if (document.getElementById('section-tasks')?.classList.contains('active')) {
                    app.renderUserDropdown();
                    app.renderTasks();
                    dashboard.renderUserDropdown();
                }
            },
            
            clearLocalData: () => {
                if (confirm('Clear all local data? This will not affect cloud data.')) {
                    localStorage.removeItem(DB_KEY_TASKS);
                    localStorage.removeItem(DB_KEY_LOGS);
                    localStorage.removeItem(DB_KEY_USERS);
                    
                    state.tasks = {};
                    state.logs = [];
                    state.currentChecks.clear();
                    
                    app.seedDefaults();
                    
                    // Refresh UI if on tasks page
                    if (document.getElementById('section-tasks')?.classList.contains('active')) {
                        app.renderUserDropdown();
                        app.renderTasks();
                    }
                    
                    showToast('Local data cleared');
                }
            },
            
            clearCloudId: () => {
                state.cloudId = null;
                state.lastSync = null;
                localStorage.removeItem(DB_KEY_CLOUD_ID);
                localStorage.removeItem(DB_KEY_LAST_SYNC);
                showToast('Cloud ID cleared. Next sync will create new record.', 'info');
            },
            
            openModal: () => {
                const modal = document.getElementById('sync-modal');
                const statusUI = document.getElementById('sync-status-ui');
                
                if (!modal || !statusUI) return;
                
                statusUI.innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <h4>Cloud Sync Status</h4>
                        <p><strong>Connection:</strong> ${state.cloudConnected ? '✅ Online' : '❌ Offline'}</p>
                        <p><strong>Cloud ID:</strong> ${state.cloudId || 'Not set'}</p>
                        <p><strong>Last Sync:</strong> ${state.lastSync ? new Date(state.lastSync).toLocaleString() : 'Never'}</p>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <h4>Local Storage</h4>
                        <p><strong>Tasks:</strong> ${Object.keys(state.tasks).length} shifts</p>
                        <p><strong>Logs:</strong> ${state.logs.length} records</p>
                        <p><strong>Users:</strong> ${state.users.length} users</p>
                        <p><strong>Auth Users:</strong> ${state.authUsers.length} accounts</p>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-success" onclick="syncManager.forceSync()">Force Sync</button>
                        <button class="btn btn-warning" onclick="syncManager.saveToCloud()">Save to Cloud</button>
                        <button class="btn btn-primary" onclick="syncManager.loadFromCloud()">Load from Cloud</button>
                        <button class="btn btn-secondary" onclick="syncManager.clearCloudId()">Clear Cloud ID</button>
                    </div>
                `;
                
                modal.classList.add('open');
            },
            
            closeModal: () => {
                const modal = document.getElementById('sync-modal');
                if (modal) modal.classList.remove('open');
            }
        };

        // ========================
        // LOCAL STORAGE MANAGEMENT
        // ========================
        const saveState = async (autoSync = true) => {
            // Save to localStorage
            localStorage.setItem(DB_KEY_TASKS, JSON.stringify(state.tasks));
            localStorage.setItem(DB_KEY_LOGS, JSON.stringify(state.logs));
            localStorage.setItem(DB_KEY_USERS, JSON.stringify(state.users));
            
            // Auto-sync to cloud if enabled and connected
            if (autoSync && state.cloudConnected && !state.cloudSyncing && navigator.onLine) {
                try {
                    await syncManager.saveToCloud();
                } catch (error) {
                    debugLog('Auto-sync failed, data saved locally');
                }
            }
        };

        // ========================
        // MAIN APPLICATION LOGIC
        // ========================
        const app = {
            init: async () => {
                debugLog('Application initializing...');
                
                // Initialize authentication first
                auth.init();
            },
            
            loadFromLocalStorage: () => {
                debugLog('Loading from local storage...');
                
                if(localStorage.getItem(DB_KEY_TASKS)) {
                    state.tasks = JSON.parse(localStorage.getItem(DB_KEY_TASKS));
                    debugLog('Tasks loaded from local storage:', Object.keys(state.tasks).length + ' shifts');
                } else {
                    debugLog('No tasks in local storage, seeding defaults');
                    app.seedDefaults();
                }

                if(localStorage.getItem(DB_KEY_LOGS)) {
                    state.logs = JSON.parse(localStorage.getItem(DB_KEY_LOGS));
                    debugLog('Logs loaded from local storage:', state.logs.length + ' records');
                }

                if(localStorage.getItem(DB_KEY_USERS)) {
                    state.users = JSON.parse(localStorage.getItem(DB_KEY_USERS));
                    debugLog('Users loaded from local storage:', state.users.length + ' users');
                } else {
                    state.users = ["Operator 1", "Manager", "Supervisor"];
                    saveState(false);
                }
            },

            seedDefaults: () => {
                debugLog('Seeding default tasks');
                ['A', 'B', 'C', 'G'].forEach(shift => {
                    state.tasks[shift] = [
                        {id: generateId(), text: 'Check Machine Status', active: true},
                        {id: generateId(), text: 'Clean Work Area', active: true},
                        {id: generateId(), text: 'Log Production Data', active: true}
                    ];
                });
                saveState(false);
            },

            renderUserDropdown: () => {
                const select = document.getElementById('user-select');
                if (!select) return;
                
                select.innerHTML = '<option value="" disabled selected>Select User...</option>';
                state.users.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u;
                    opt.innerText = u;
                    select.appendChild(opt);
                });
            },

            navigate: (view) => {
                // Hide all sections
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                // Show selected section
                const section = document.getElementById(`section-${view}`);
                if (section) section.classList.add('active');
                
                // Update navigation buttons
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.innerText.toLowerCase().includes(view.toLowerCase()));
                });

                if(view === 'dashboard') {
                    // Render dashboard cards
                    auth.renderDashboardCards();
                } else if(view === 'users') {
                    // Render user table
                    userManagement.renderUserTable();
                } else if(view === 'tasks') {
                    // Set up UI
                    const today = new Date().toISOString().split('T')[0];
                    const dateInput = document.getElementById('report-date');
                    if (dateInput) dateInput.value = today;
                    
                    // Render tasks and dropdowns
                    app.renderUserDropdown();
                    app.renderTasks();
                    dashboard.renderUserDropdown();
                }
            },

            setShift: (shift) => {
                state.currentShift = shift;
                state.currentChecks.clear();
                
                document.querySelectorAll('.shift-tab').forEach(btn => {
                    btn.classList.toggle('active', btn.innerText.includes(shift));
                });
                app.renderTasks();
            },

            renderTasks: () => {
                const listEl = document.getElementById('task-list-ui');
                if (!listEl) return;
                
                listEl.innerHTML = '';
                
                const userSelect = document.getElementById('user-select');
                const dateInput = document.getElementById('report-date');
                
                const user = userSelect ? userSelect.value : '';
                const date = dateInput ? dateInput.value : new Date().toISOString().split('T')[0];
                const shift = state.currentShift;
                const tasks = state.tasks[shift] || [];
                let activeCount = 0;

                let previousLog = null;
                if (user && date) {
                    const matchingLogs = state.logs.filter(l => 
                        l.user === user && 
                        l.reportDate === date && 
                        l.shift === shift
                    );
                    
                    if (matchingLogs.length > 0) {
                        matchingLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        previousLog = matchingLogs[0];
                    }
                }

                state.currentChecks.clear();
                if (previousLog && previousLog.checkedTaskIds) {
                    previousLog.checkedTaskIds.forEach(id => state.currentChecks.add(id));
                }

                tasks.forEach(t => {
                    if(!t.active) return;
                    activeCount++;
                    const isChecked = state.currentChecks.has(t.id);
                    
                    const li = document.createElement('li');
                    li.className = `task-item ${isChecked ? 'checked' : 'unchecked'}`;
                    
                    li.innerHTML = `
                        <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="app.toggleCheck('${t.id}', this)">
                        <span class="task-text">${t.text}</span>
                    `;
                    listEl.appendChild(li);
                });

                if(activeCount === 0) listEl.innerHTML = '<div style="padding:1rem; color:var(--secondary);">No active tasks.</div>';
                app.updateProgress(activeCount);
            },

            toggleCheck: (id, box) => {
                const li = box.closest('.task-item');
                if(box.checked) { 
                    state.currentChecks.add(id); 
                    if(li) {
                        li.classList.remove('unchecked');
                        li.classList.add('checked'); 
                    }
                } else { 
                    state.currentChecks.delete(id); 
                    if(li) {
                        li.classList.remove('checked');
                        li.classList.add('unchecked'); 
                    }
                }
                
                const totalActive = state.tasks[state.currentShift].filter(t => t.active).length;
                app.updateProgress(totalActive);
                
                saveState(true);
            },

            updateProgress: (total) => {
                const pct = total === 0 ? 0 : Math.round((state.currentChecks.size / total) * 100);
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                
                if (progressBar) progressBar.style.width = `${pct}%`;
                if (progressText) progressText.innerText = `${pct}%`;
            },

            submitTasks: async () => {
                const userSelect = document.getElementById('user-select');
                const dateInput = document.getElementById('report-date');
                
                const user = userSelect ? userSelect.value : '';
                const date = dateInput ? dateInput.value : '';
                
                if(!user) { showToast('Please select a user', 'error'); return; }
                if(!date) { showToast('Please select a date', 'error'); return; }

                const tasks = state.tasks[state.currentShift].filter(t => t.active);
                if(tasks.length === 0) { showToast('No active tasks to submit', 'error'); return; }

                const record = {
                    id: generateId(),
                    timestamp: new Date().toISOString(),
                    reportDate: date, 
                    shift: state.currentShift,
                    user: user,
                    total: tasks.length,
                    completed: state.currentChecks.size,
                    percentage: Math.round((state.currentChecks.size / tasks.length) * 100),
                    checkedTaskIds: Array.from(state.currentChecks)
                };

                state.logs.unshift(record);
                await saveState(true);
                showToast(`Report for ${date} submitted!`);
                
                state.currentChecks.clear();
                app.renderTasks();
            }
        };

        // ========================
        // EDITOR LOGIC
        // ========================
        const editor = {
            openModal: () => {
                const modal = document.getElementById('editor-modal');
                const shiftLabel = document.getElementById('editor-shift-label');
                
                if (modal) modal.classList.add('open');
                if (shiftLabel) shiftLabel.innerText = 'Shift ' + state.currentShift;
                editor.renderList();
            },
            closeModal: () => {
                const modal = document.getElementById('editor-modal');
                if (modal) modal.classList.remove('open');
                app.renderTasks();
            },
            renderList: () => {
                const list = document.getElementById('editor-list-ui');
                if (!list) return;
                
                list.innerHTML = '';
                state.tasks[state.currentShift].forEach((t, idx) => {
                    const div = document.createElement('div');
                    div.className = 'user-list-item';
                    div.innerHTML = `
                        <span contenteditable="true" style="flex:1; padding:4px;" onblur="editor.updateText('${t.id}', this)">${t.text}</span>
                        <button class="btn ${t.active ? 'btn-secondary' : 'btn-danger'} btn-sm" onclick="editor.toggleActive('${t.id}')">${t.active ? 'Active' : 'Inactive'}</button>
                        <button class="btn btn-danger btn-sm" onclick="editor.delete('${t.id}')">Del</button>
                    `;
                    list.appendChild(div);
                });
            },
            addTask: () => {
                const input = document.getElementById('new-task-input');
                if (!input) return;
                
                const val = input.value.trim();
                if(!val) return;
                state.tasks[state.currentShift].push({ id: generateId(), text: val, active: true });
                input.value = '';
                saveState(true); 
                editor.renderList();
            },
            updateText: (id, el) => {
                const t = state.tasks[state.currentShift].find(x => x.id === id);
                if(t) { t.text = el.innerText; saveState(true); }
            },
            toggleActive: (id) => {
                const t = state.tasks[state.currentShift].find(x => x.id === id);
                if(t) { t.active = !t.active; saveState(true); editor.renderList(); }
            },
            delete: (id) => {
                state.tasks[state.currentShift] = state.tasks[state.currentShift].filter(x => x.id !== id);
                saveState(true); 
                editor.renderList();
            }
        };

        // ========================
        // USER MANAGER LOGIC
        // ========================
        const userManager = {
            openModal: () => {
                const modal = document.getElementById('user-modal');
                if (modal) modal.classList.add('open');
                userManager.renderList();
            },
            closeModal: () => {
                const modal = document.getElementById('user-modal');
                if (modal) modal.classList.remove('open');
                app.renderUserDropdown();
                dashboard.renderUserDropdown();
            },
            renderList: () => {
                const list = document.getElementById('user-list-ui');
                if (!list) return;
                
                list.innerHTML = '';
                state.users.forEach((u, i) => {
                    const div = document.createElement('div');
                    div.className = 'user-list-item';
                    div.innerHTML = `
                        <span>${u}</span>
                        <button class="btn btn-danger btn-sm" onclick="userManager.delete(${i})">Remove</button>
                    `;
                    list.appendChild(div);
                });
            },
            addUser: () => {
                const input = document.getElementById('new-user-input');
                if (!input) return;
                
                const val = input.value.trim();
                if(!val) return;
                if(state.users.includes(val)) { showToast('User already exists', 'error'); return; }
                state.users.push(val);
                input.value = '';
                saveState(true); 
                userManager.renderList();
            },
            delete: (idx) => {
                state.users.splice(idx, 1);
                saveState(true); 
                userManager.renderList();
            }
        };

        // ========================
        // DASHBOARD LOGIC
        // ========================
        const dashboard = {
            setMode: (mode) => {
                state.dashboardMode = mode;
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.innerText.toLowerCase() === mode || (mode === 'custom' && btn.innerText === 'Custom'));
                });
                
                const rangeInputs = document.getElementById('custom-range-inputs');
                if(rangeInputs) {
                    if(mode === 'custom') rangeInputs.classList.remove('hidden');
                    else rangeInputs.classList.add('hidden');
                }

                dashboard.render();
            },

            setUserFilter: (val) => {
                state.dashUserFilter = val;
                dashboard.render();
            },

            sortBy: (key) => {
                if (state.sortKey === key) {
                    state.sortOrder = state.sortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    state.sortKey = key;
                    state.sortOrder = 'desc';
                }
                dashboard.render();
            },

            getProcessedLogs: () => {
                const now = new Date();
                const todayStr = now.toISOString().split('T')[0];
                
                let logs = state.logs.filter(log => {
                    const d = new Date(log.reportDate);
                    const dStr = log.reportDate;

                    if (state.dashboardMode === 'daily') return dStr === todayStr;
                    else if (state.dashboardMode === 'monthly') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    else if (state.dashboardMode === 'yearly') return d.getFullYear() === now.getFullYear();
                    else if (state.dashboardMode === 'custom') {
                        const startInput = document.getElementById('range-start');
                        const endInput = document.getElementById('range-end');
                        const start = startInput ? startInput.value : todayStr;
                        const end = endInput ? endInput.value : todayStr;
                        return dStr >= start && dStr <= end;
                    }
                    return true;
                });

                if (state.dashUserFilter !== 'ALL') {
                    logs = logs.filter(l => l.user === state.dashUserFilter);
                }

                return logs;
            },

            updateCustomView: () => {
                if(state.dashboardMode === 'custom') dashboard.render();
            },
            
            renderUserDropdown: () => {
                const userSelect = document.getElementById('dash-user-select');
                if (!userSelect) return;
                
                userSelect.innerHTML = '';
                const allOpt = document.createElement('option');
                allOpt.value = 'ALL';
                allOpt.innerText = 'ALL Users';
                userSelect.appendChild(allOpt);
                
                state.users.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u;
                    opt.innerText = u;
                    userSelect.appendChild(opt);
                });
                userSelect.value = state.dashUserFilter;
            },

            render: () => {
                const userSelect = document.getElementById('dash-user-select');
                if (userSelect && userSelect.options.length !== state.users.length + 1) {
                    dashboard.renderUserDropdown();
                }

                let logs = dashboard.getProcessedLogs();
                
                const statTotal = document.getElementById('stat-total');
                const statAvg = document.getElementById('stat-avg');
                
                if (statTotal) statTotal.innerText = logs.length;
                if (statAvg) {
                    const avg = logs.length ? Math.round(logs.reduce((a,b)=>a+b.percentage, 0)/logs.length) : 0;
                    statAvg.innerText = avg + '%';
                }

                const chartData = [];
                
                if (state.dashboardMode === 'daily') {
                    const shifts = {A:[], B:[], C:[], G:[]};
                    logs.forEach(l => { if(shifts[l.shift]) shifts[l.shift].push(l.percentage); });
                    Object.keys(shifts).forEach(s => {
                        const arr = shifts[s];
                        const val = arr.length ? Math.round(arr.reduce((a,b)=>a+b,0)/arr.length) : 0;
                        chartData.push({ label: 'Shift '+s, value: val });
                    });
                } 
                else if (state.dashboardMode === 'monthly') {
                    const days = {}; 
                    logs.forEach(l => {
                        const day = new Date(l.reportDate).getDate();
                        if(!days[day]) days[day] = [];
                        days[day].push(l.percentage);
                    });
                    Object.keys(days).sort((a,b)=>a-b).forEach(d => {
                        const val = days[d].length ? Math.round(days[d].reduce((a,b)=>a+b,0)/days[d].length) : 0;
                        chartData.push({ label: d+'th', value: val });
                    });
                }
                else if (state.dashboardMode === 'yearly') {
                    const months = Array(12).fill(0).map(()=>[]); 
                    const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                    logs.forEach(l => {
                        const m = new Date(l.reportDate).getMonth();
                        months[m].push(l.percentage);
                    });
                    months.forEach((mData, idx) => {
                        if(mData.length) {
                            const val = Math.round(mData.reduce((a,b)=>a+b,0)/mData.length);
                            chartData.push({ label: monthNames[idx], value: val });
                        } else {
                            chartData.push({ label: monthNames[idx], value: 0 });
                        }
                    });
                }
                else if (state.dashboardMode === 'custom') {
                    const dateMap = {};
                    logs.forEach(l => {
                        if(!dateMap[l.reportDate]) dateMap[l.reportDate] = [];
                        dateMap[l.reportDate].push(l.percentage);
                    });
                    Object.keys(dateMap).sort().forEach(d => {
                        const val = dateMap[d].length ? Math.round(dateMap[d].reduce((a,b)=>a+b,0)/dateMap[d].length) : 0;
                        chartData.push({ label: d.substring(5), value: val });
                    });
                }

                const chartEl = document.getElementById('main-chart');
                if (chartEl) {
                    chartEl.innerHTML = '';
                    if(chartData.length === 0) {
                        chartEl.innerHTML = '<div style="color:var(--secondary); margin:auto;">No data for this period</div>';
                    } else {
                        const maxVal = Math.max(...chartData.map(d => d.value)) || 100;
                        chartData.forEach(d => {
                            const height = (d.value / maxVal) * 100;
                            const group = document.createElement('div');
                            group.className = 'bar-group';
                            group.innerHTML = `
                                <div class="bar" style="height: ${height}%;" data-val="${d.value}%"></div>
                                <div class="bar-label">${d.label}</div>
                            `;
                            chartEl.appendChild(group);
                        });
                    }
                }

                let tableLogs = [...logs];
                tableLogs.sort((a, b) => {
                    let valA = a[state.sortKey];
                    let valB = b[state.sortKey];
                    if (state.sortKey === 'reportDate') {
                        valA = new Date(valA);
                        valB = new Date(valB);
                    }
                    if (valA < valB) return state.sortOrder === 'asc' ? -1 : 1;
                    if (valA > valB) return state.sortOrder === 'asc' ? 1 : -1;
                    return 0;
                });

                ['reportDate', 'shift', 'user', 'percentage'].forEach(k => {
                    const icon = document.getElementById(`sort-${k}`);
                    if(icon) {
                        if(state.sortKey === k) {
                            icon.innerText = state.sortOrder === 'asc' ? '▲' : '▼';
                            icon.style.color = 'var(--primary)';
                        } else {
                            icon.innerText = '⬍';
                            icon.style.color = 'var(--secondary)';
                        }
                    }
                });

                const tbody = document.getElementById('log-table-body');
                if (tbody) {
                    tbody.innerHTML = '';
                    tableLogs.slice(0, 20).forEach(l => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${l.reportDate}</td>
                            <td><span style="font-weight:bold">${l.shift}</span></td>
                            <td>${l.user}</td>
                            <td>
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <div style="flex:1; height:6px; background:#e2e8f0; border-radius:3px; width:60px;">
                                        <div style="width:${l.percentage}%; height:100%; background:var(--success); border-radius:3px;"></div>
                                    </div>
                                    ${l.percentage}%
                                </div>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            }
        };

        // ========================
        // INITIALIZE APPLICATION
        // ========================
        window.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>